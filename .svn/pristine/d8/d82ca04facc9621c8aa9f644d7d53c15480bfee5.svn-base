<?php 
App::import('Controller', 'Users');
App::import('Controller', 'EmpresaUsuarios');
App::import('Controller', 'Dispositivos');
App::import('Controller', 'ListaDispositivos');
App::import('Controller', 'Videos');
App::import('Controller', 'ListaVideos');
App::import('Controller', 'Lista');
App::import('Controller', 'Consejos');
App::import('Controller', 'ActualizacionDispositivos');
App::import('Controller', 'Reproductors');
class AgenciaController extends AppController{

	var $name="Agencia";
	public $components = array('DebugKit.Toolbar','RequestHandler', 'Auth');
	var $uses = array('Users','Empresas'); 
	
	
	public function beforeFilter(){
		parent::beforeFilter();
		$empresa = $this->Session->read('Empresa');
		if($empresa['agencia']['clientes'] > 0){
			$this->layout = 'agencia';
		}else{
			$this->redirect(array('controller'=>'Videos','action'=>'index'));
		}
		
	}

	public function clearCache(){
		Cache::clear(false);
		$this->redirect(array('action'=>'index'));
	}
	public function index(){
		$this->loadModel('Dispositivo');
		$this->loadModel('Empresa');
		$empresa = $this->Session->read("Empresa");
		$idEmpresa = $empresa['Empresa']['idEmpresa'];

		//$this->Empresa->find('all',array('conditions')->)
		$cuentaClientes = $empresa['agencia']['clientes'];
		if ( $cuentaClientes > 0 ){
			$i = 0;
			$clientes = $empresa['agencia'];
			foreach( $clientes as $cliente){
				if (is_array($cliente)){
					$idEmpresaCliente = $cliente['Agencia']['idCliente'];
					$dispositivos = $this->Dispositivo->find('all',array('conditions'=>'idEmpresa ='.$idEmpresaCliente." and acepta_terceros = 1"));
					$cliente['dispositivos'] = $dispositivos;
					$i++;
					$arrayClientes[$i] = $cliente;
				}
			}
			$this->set('clientes',$arrayClientes);

			//$this->Session->setFlash(__('Nombres '.$agencianoms));
		}
		
		$this->render('index', 'agencia');
	}
	
	public function listadoDispositivos(){
		/*$options['fields'] = array('User.id','User.username','timestampCreacion','timestampLAcceso','count(distinct empresaUsuario.idEmpresa) empresas', 'nivel', 'welcome');
		$options['group'] = array('User.id');
		$options['order'] = array('User.timestampLAcceso DESC');
		$options['joins'] = array(
				array('table' => 'empresaUsuario',			
						'type' => 'left',
						'conditions' => array(
								'empresaUsuario.idUsuario = User.id',
									
						)
				)
		);
		$this->listarUsuarios($options);
		$this->render('listadoDispositivos','admin');
		*/
	}
	
	
	
}

	
	

?>