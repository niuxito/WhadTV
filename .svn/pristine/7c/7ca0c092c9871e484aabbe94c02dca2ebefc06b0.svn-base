<?php
App::uses('AppController', 'Controller');
/**
 * Videos Controller
 *
 * @property Video $Video
 * 
 */
class ConsejosController extends AppController {
		public $components = array('DebugKit.Toolbar','RequestHandler', 'Auth');

		public function index(){
			$this->Consejo->recursive = 0;
			$this->set('Consejos', $this->Consejo->find('all'));

		}

		public function add(){
			if ($this->request->is('post')) {
				$this->Consejo->create();

				$user = $this->Session->read('Auth');
				$this->request->data['Consejo']['idUsuario'] = $user['User']['id'];
				$this->request->data['Consejo']['page'] = $this->referer();
				
				$options['fields'] = array('max(idAsunto)idAsunto');
				$resultado =$this->Consejo->find("all", $options);
				if(count( $resultado) > 0){
					$this->request->data['Consejo']['idAsunto'] = $resultado[0][0]['idAsunto'] + 1;
				}else{
					$this->request->data['Consejo']['idAsunto'] = 1;
				}
				if ($this->Consejo->save($this->request->data)) {
					$this->Session->setFlash(__('Tu consejo ha sido enviado, lo tendremos en cuenta.'));
					$this->redirect($this->referer());
				} else {
					$this->Session->setFlash(__('El consejo no ha podido guardarse. Por favor, intentalo de nuevo.'));
				}
			}
		}
		
		public function cuentaConsejos($idUsuario = null){
			$options['fields'] = array('count(idAsunto)cuenta');
			$options['conditions'] = array('idUsuario = '.$idUsuario);
			$resultado =$this->Consejo->find("all", $options);
			return $resultado[0][0]['cuenta'];
		}
		
		public function listadoConsejos($idUsuario = null){
			$options['fields'] = array('idConsejo','descripcion','idUsuario','users.username','situacion','created','idAsunto');
			$options['group'] = array('idAsunto');
			$options['conditions'] = array("idUsuario = ".$idUsuario." and idConsejo IN (SELECT MIN(idConsejo) FROM `consejo` GROUP BY idAsunto)");
			$options['joins'] = array(
					array('table' => 'users',			
							'type' => 'left',
							'conditions' => array(
									'users.id = Consejo.idUsuario',
										
							)
					)
			);
			$options['order'] = ('situacion desc,idAsunto');
			$this->set('consejos',$this->Consejo->find('all',$options));
			
			
			$options2['fields'] = array('idAsunto','count(distinct idConsejo) nMensajes');
			$options2['group'] = array('idAsunto');
			$options2['order'] = ('idAsunto');
			
			$this->set('cuentaMensajes',$this->Consejo->find('all',$options2));
			
			if ($this->request->is('post')) {
				$user = $this->Session->read('Auth');
				$this->request->data['Consejo1']['idUsuario'] = $user['User']['id'];
				$this->request->data['Consejo1']['page'] = $this->referer();
				$optionsMxid['fields'] = array('max(idAsunto)idAsunto');
				$resultadoMxid =$this->Consejo->find("all", $optionsMxid);
				if(count( $resultadoMxid) > 0){
					$this->request->data['Consejo1']['idAsunto'] = $resultadoMxid[0][0]['idAsunto'] + 1;
				}else{
					$this->request->data['Consejo1']['idAsunto'] = 1;
				}
				$this->request->data['Consejo'] = $this->request->data['Consejo1'];
				if ($this->Consejo->save($this->request->data)) {
					$this->Session->setFlash(__('Tu consejo ha sido enviado, lo tendremos en cuenta.'));
					$this->redirect(array('action' => 'listadoConsejos/'.$idUsuario));
				} else {
					$this->Session->setFlash(__('El consejo no ha podido guardarse. Por favor, intentalo de nuevo.'));
				}
			}
			
			$this->render('listadoConsejos','admin');
		
		}
		
		public function listadoAsunto($idAsunto = null){
			$options['fields'] = array('idConsejo','descripcion','idUsuario','users.username','situacion','created','idAsunto');
			$options['conditions'] = array('idAsunto ='.$idAsunto);
			$options['joins'] = array(
					array('table' => 'users',			
							'type' => 'left',
							'conditions' => array(
									'users.id = Consejo.idUsuario',
										
							)
					)
			);
			$options['order'] = ('idAsunto,idConsejo');
			$this->set('consejos',$this->Consejo->find('all',$options));
		
			if ($this->request->is('post')) {
				$user = $this->Session->read('Auth');
				$this->request->data['Consejo1']['idUsuario'] = $user['User']['id'];
				$this->request->data['Consejo1']['page'] = $this->referer();
				$this->request->data['Consejo1']['idAsunto'] = $idAsunto;
				$options['fields'] = array('situacion');
				$options['conditions'] = array('idAsunto ='.$idAsunto); 
				$options['order'] = ('idConsejo');
				$resultado =$this->Consejo->find("all", $options);
				if(count($resultado) > 0){
					$this->request->data['Consejo1']['situacion'] = $resultado[0]['Consejo']['situacion'];
				}else{
					$this->request->data['Consejo1']['situacion'] = 1;
				}
				$this->request->data['Consejo'] = $this->request->data['Consejo1'];
				if ($this->Consejo->save($this->request->data)) {
					$this->Session->setFlash(__('Respuesta enviada.'));
					$this->redirect(array('action' => 'listadoAsunto/'.$idAsunto));
				} else {
					$this->Session->setFlash(__('La respuesta no ha podido guardarse. Por favor, intentalo de nuevo.'));
				}
			}
		
		}
}
